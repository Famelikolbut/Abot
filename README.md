# Telegram-бот для аналитики видео

Бот позволяет анализировать статистику по видео (просмотры, лайки, комментарии) с помощью запросов на естественном языке.

## Запуск проекта (Docker)

Проект полностью контейнеризирован. Для запуска вам понадобится установленнный **Docker** и **Docker Compose**.

### 1. Настройка окружения

Создайте файл `.env` в корне проекта (или используйте существующий шаблон) и укажите необходимые ключи:

```env
BOT_TOKEN=ваш_токен_телеграм_бота
GROQ_API_KEY=ваш_ключ_от_groq_api
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=db
DB_PORT=5432
DB_NAME=video_analytics
```

### 2. Запуск контейнеров

Выполните команду в корне проекта:

```bash
docker-compose up -d --build
```

Эта команда:
1.  Соберет образ бота.
2.  Запустит PostgreSQL.
3.  Автоматически применит миграции базы данных (Alembic).
4.  Запустит бота.

### 3. Загрузка данных

По условию задания, данные предоставляются в JSON-файле.
Чтобы загрузить их в базу:
1.  Откройте чат с ботом.
2.  Отправьте ему файл `videos.json` как документ.
3.  Бот автоматически очистит старые данные и загрузит новые.

## Архитектура

Проект построен по принципам чистой архитектуры:

*   **bot/**: Слой представления. Хэндлеры Aiogram (`handlers.py`) принимают сообщения и файлы.
*   **services/**: Слой бизнес-логики.
    *   `llm_service.py`: Взаимодействие с LLM (Groq) для генерации SQL.
    *   `query_executor.py`: Выполнение безопасных SQL-запросов к БД.
    *   `data_loader.py`: Логика парсинга и загрузки JSON-дампов.
*   **database/**: Слой данных. Модели SQLAlchemy (`models.py`) и конфигурация сессии.
*   **alembic/**: Миграции базы данных.

Технологический стек: Python 3.11, Aiogram 3.x, SQLAlchemy (Async), PostgreSQL, AsyncPG, Docker.

## Подход к обработке запросов (NL-to-SQL)

Для преобразования текстовых вопросов пользователя в SQL-запросы используется LLM (через Groq API).

### Описание схемы данных
В промпт модели передается DDL-подобное описание таблиц:
*   `videos`: Основная информация (ID, автор, итоговые счетчики).
*   `video_snapshots`: Почасовая статистика и дельты (прирост) просмотров/лайков.

### Промпт (Prompt Engineering)
Используется системный промпт со следующими инструкциями:
1.  **Роль**: Expert PostgreSQL Data Analyst.
2.  **Схема**: Детальное описание полей и связей.
3.  **Правила**:
    *   Обязательно возвращать только валидный SQL.
    *   Запрет на Markdown и пояснения.
    *   Указание текущего контекста (год 2025).
    *   Примеры типовых запросов ("Сколько видео...", "Прирост за дату...").
    *   **CRITICAL**: Запрет на использование JSON-вывода и вызовов инструментов (tools), только raw SQL string.

### Безопасность
Пользовательские запросы преобразуются в SQL, который выполняется в режиме `read-only` (через `session.execute`). Бот ожидает от запроса возврата единственного числового значения (scalar), что соответствует требованиям задания ("ответ - одно число").
